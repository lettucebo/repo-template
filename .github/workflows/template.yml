name: Repository Template Setup

on:
  push:
    branches:
      - main

permissions:
  contents: write
  security-events: write
  issues: write
  actions: write

jobs:
  setup:
    name: Setup Repository
    # Only run if this is not the template repository
    if: |
      !github.event.repository.is_template
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup GitHub Repository
        id: setup
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const results = {
              vulnerabilityAlerts: '‚ùå',
              automatedSecurityFixes: '‚ùå',
              secretScanning: '‚ùå',
              dependabot: '‚ùå',
              label: '‚ùå'
            };
            
            console.log('üöÄ Starting repository setup...');
            
            // Step 1: Enable GitHub Advanced Security features
            console.log('üìä Enabling GitHub Advanced Security features...');
            
            // Enable vulnerability alerts
            try {
              await github.rest.repos.enableVulnerabilityAlerts({
                owner,
                repo
              });
              console.log('‚úÖ Vulnerability alerts enabled');
              results.vulnerabilityAlerts = '‚úÖ';
            } catch (error) {
              console.log('‚ö†Ô∏è  Vulnerability alerts:', error.message);
            }
            
            // Enable automated security fixes (Dependabot security updates)
            try {
              await github.rest.repos.enableAutomatedSecurityFixes({
                owner,
                repo
              });
              console.log('‚úÖ Automated security fixes enabled');
              results.automatedSecurityFixes = '‚úÖ';
            } catch (error) {
              console.log('‚ö†Ô∏è  Automated security fixes:', error.message);
            }
            
            // Enable Secret Scanning (requires GHAS for private repos)
            try {
              await github.rest.repos.update({
                owner,
                repo,
                security_and_analysis: {
                  secret_scanning: {
                    status: 'enabled'
                  }
                }
              });
              console.log('‚úÖ Secret scanning enabled');
              results.secretScanning = '‚úÖ';
            } catch (error) {
              console.log('‚ö†Ô∏è  Secret scanning:', error.message);
            }
            
            // Step 2: Create the label
            console.log('üè∑Ô∏è  Creating label...');
            
            try {
              await github.rest.issues.createLabel({
                owner,
                repo,
                name: 'run-release',
                description: 'It will trigger the release for the PR',
                color: 'E9D05A'
              });
              console.log('‚úÖ Label "run-release" created successfully');
              results.label = '‚úÖ';
            } catch (error) {
              if (error.status === 422) {
                console.log('‚ÑπÔ∏è  Label "run-release" already exists');
                results.label = '‚úÖ';
              } else {
                console.log('‚ùå Error creating label:', error.message);
              }
            }
            
            console.log('‚úÖ Repository setup completed!');
            
            // Store results for summary
            core.setOutput('results', JSON.stringify(results));
            return results;

      - name: Update README.md
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            console.log('üìù Updating README.md with repository name...');
            
            try {
              // Get current README.md
              const { data: readmeData } = await github.rest.repos.getContent({
                owner,
                repo,
                path: 'README.md'
              });
              
              // Decode content
              const content = Buffer.from(readmeData.content, 'base64').toString('utf-8');
              
              // Replace the first heading with the repository name
              const updatedContent = content.replace(/^#\s+.+$/m, `# ${repo}`);
              
              // Update README.md
              await github.rest.repos.createOrUpdateFileContents({
                owner,
                repo,
                path: 'README.md',
                message: 'docs: update README title with repository name',
                content: Buffer.from(updatedContent).toString('base64'),
                sha: readmeData.sha
              });
              
              console.log('‚úÖ README.md updated successfully');
            } catch (error) {
              console.log('‚ö†Ô∏è  README.md update:', error.message);
            }

      - name: Configure Copilot Coding Agent
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            console.log('‚öôÔ∏è  Configuring Copilot Coding Agent...');
            
            try {
              // Configure allowed domains for Copilot Coding Agent
              // This allows the agent to access Google Fonts
              await github.request('PUT /repos/{owner}/{repo}/copilot/coding-agent/allowed-domains', {
                owner,
                repo,
                allowed_domains: [
                  'fonts.googleapis.com',
                  'fonts.gstatic.com'
                ],
                headers: {
                  'X-GitHub-Api-Version': '2022-11-28'
                }
              });
              console.log('‚úÖ Copilot Coding Agent allowed domains configured');
            } catch (error) {
              console.log('‚ö†Ô∏è  Copilot Coding Agent configuration:', error.message);
              console.log('Note: This feature might require specific repository permissions or GitHub plan');
            }

      - name: Create Dependabot configuration
        run: |
          mkdir -p .github
          cat > .github/dependabot.yml << 'EOF'
          version: 2
          updates:
            - package-ecosystem: "github-actions"
              directory: "/"
              schedule:
                interval: "weekly"
          EOF
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/dependabot.yml
          git diff --cached --quiet || git commit -m "chore: add dependabot configuration"
          git push || true

      - name: Create CodeQL workflow
        run: |
          mkdir -p .github/workflows
          cat > .github/workflows/codeql.yml << 'EOF'
          name: "CodeQL"

          on:
            push:
              branches: [ "main" ]
            pull_request:
              branches: [ "main" ]
            schedule:
              - cron: '0 0 * * 1'

          jobs:
            analyze:
              name: Analyze
              runs-on: ubuntu-latest
              permissions:
                actions: read
                contents: read
                security-events: write

              strategy:
                fail-fast: false
                matrix:
                  language: [ 'javascript' ]

              steps:
              - name: Checkout repository
                uses: actions/checkout@v4

              - name: Initialize CodeQL
                uses: github/codeql-action/init@v3
                with:
                  languages: ${{ matrix.language }}

              - name: Autobuild
                uses: github/codeql-action/autobuild@v3

              - name: Perform CodeQL Analysis
                uses: github/codeql-action/analyze@v3
          EOF
          
          git add .github/workflows/codeql.yml
          git diff --cached --quiet || git commit -m "chore: add CodeQL workflow"
          git push || true

      - name: Generate Summary
        if: always()
        run: |
          echo "# üéâ Repository Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Security Features Enabled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Feature | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          
          RESULTS='${{ steps.setup.outputs.results }}'
          
          echo "| Vulnerability Alerts | $(echo $RESULTS | jq -r '.vulnerabilityAlerts') |" >> $GITHUB_STEP_SUMMARY
          echo "| Automated Security Fixes | $(echo $RESULTS | jq -r '.automatedSecurityFixes') |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scanning | $(echo $RESULTS | jq -r '.secretScanning') |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependabot Configuration | ‚úÖ |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Workflow | ‚úÖ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Labels Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Label | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| run-release | $(echo $RESULTS | jq -r '.label') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ú® **This workflow will now delete itself to keep your repository clean.**" >> $GITHUB_STEP_SUMMARY

      - name: Delete this workflow
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const path = '.github/workflows/template.yml';
            
            console.log('üóëÔ∏è  Deleting template.yml...');
            
            try {
              // Get the file to obtain its SHA
              const { data: fileData } = await github.rest.repos.getContent({
                owner,
                repo,
                path
              });
              
              // Delete the file
              await github.rest.repos.deleteFile({
                owner,
                repo,
                path,
                message: 'chore: remove template.yml after setup completion',
                sha: fileData.sha
              });
              
              console.log('‚úÖ template.yml deleted successfully');
            } catch (error) {
              console.log('‚ùå Error deleting template.yml:', error.message);
            }
